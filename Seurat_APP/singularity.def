Bootstrap: docker
From: rocker/r-ver:4.3.1

%labels
    Author YourName

%post
    # --- System dependencies ---
    apt-get update && apt-get install -y \
        libxml2-dev \
        libssl-dev \
        libcurl4-openssl-dev \
        libhdf5-dev \
        libfftw3-dev \
        libblas-dev \
        liblapack-dev \
        libcairo2-dev \
        libxt-dev \
        libpng-dev \
        libtiff5-dev \
        libjpeg-dev \
        libfreetype6-dev \
        libgit2-dev \
        libmariadb-dev \
        libsqlite3-dev \
        libglpk-dev \
        libharfbuzz-dev \
        libfribidi-dev \
        gfortran \
        make \
        gcc \
        gdebi-core \
        ca-certificates \
        wget

    # --- Base R helpers ---
    Rscript -e "install.packages(c('shiny','remotes','BiocManager'), repos='https://cloud.r-project.org')"

    # --- Matrix (>=1.6.4) pin for SeuratObject ---
    wget https://cran.r-project.org/src/contrib/Archive/Matrix/Matrix_1.6-5.tar.gz
    R CMD INSTALL Matrix_1.6-5.tar.gz

    # --- Extra dependencies for Seurat/SeuratObject & common pipelines ---
    Rscript -e "install.packages(c( \
        'sp','future','future.apply','progressr','spam','generics','RcppEigen', \
        'ggplot2','DT','plotly','randomForest','caret','markdown','pwr','RColorBrewer','lattice', \
        'ggrepel','uwot','RANN','RcppAnnoy','sctransform','pROC','data.table','patchwork','e1071', \
        'gprofiler2','enrichR' \
      ), repos='https://cloud.r-project.org')"

    # --- SeuratObject >= 5.0.2 (pin) ---
    wget https://cran.r-project.org/src/contrib/Archive/SeuratObject/SeuratObject_5.0.2.tar.gz
    R CMD INSTALL SeuratObject_5.0.2.tar.gz

    # --- Seurat (from GitHub, current v5.x) ---
    Rscript -e "remotes::install_github('satijalab/seurat')"

    # --- cleanup ---
    apt-get clean
    rm -rf /var/lib/apt/lists/*
    rm -f Matrix_1.6-5.tar.gz SeuratObject_5.0.2.tar.gz

%files
    app.R /srv/shiny-server/app/
    www/ /srv/shiny-server/app/www/
    Readme.txt /srv/shiny-server/app/

%environment
    export SHINY_PORT=3838
    export SHINY_HOST=0.0.0.0

%runscript
    exec R -e "shiny::runApp('/srv/shiny-server/app', host = Sys.getenv('SHINY_HOST', '0.0.0.0'), port = as.numeric(Sys.getenv('SHINY_PORT', 3838)), launch.browser = FALSE)"
